import{d as e,g as r,s as t,h as o,k as a}from"../../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const d=e(async e=>{const d=r(e),s=await t(e),n=o(e,"id");if("PATCH"!==d)return{data:{success:!1,error:"Método no permitido"}};if(!n)return{data:{success:!1,error:"ID de pedido requerido"}};try{const r=await a(e);if(!r.payment_status)return{data:{success:!1,error:"El nuevo estado de pago es requerido"}};const t=["pending","paid","failed","refunded"];if(!r.payment_status||!t.includes(r.payment_status))return{data:{success:!1,error:"Estado de pago no válido. Estados permitidos: pending, paid, failed, refunded"}};const o=await s.from("orders").select("id_order, payment_status, status").eq("id_order",n).single(),d=o.error,i=o.data;if(d)return"PGRST116"===d.code?{data:{success:!1,error:"Pedido no encontrado"}}:(console.error("Error obteniendo pedido:",d),{data:{success:!1,error:"Error obteniendo pedido",details:d.message}});const p=i.payment_status,u=r.payment_status,c={pending:["paid","failed"],paid:["refunded"],failed:["pending","paid"],refunded:[]};if(!c[p].includes(u))return{data:{success:!1,error:`No se puede cambiar el estado de pago de '${p}' a '${u}'. Transiciones permitidas: ${c[p].join(", ")}`}};if("refunded"===u&&"paid"!==p)return{data:{success:!1,error:"Solo se puede reembolsar un pedido que esté pagado"}};if("paid"===u&&"refunded"===p)return{data:{success:!1,error:"No se puede marcar como pagado un pedido reembolsado"}};const m={payment_status:u,updated_at:(new Date).toISOString()};r.notes&&(m.notes=r.notes.trim()),r.payment_method&&(m.payment_method=r.payment_method.trim()),r.payment_reference&&(m.payment_reference=r.payment_reference.trim());const _=s,f=await _.from("orders").update(m).eq("id_order",n).select("id_order, payment_status, payment_method, notes, updated_at").single(),l=f.error,y=f.data;if(l)return console.error("Error actualizando estado de pago del pedido:",l),{data:{success:!1,error:"Error actualizando estado de pago del pedido",details:l.message}};if("failed"===u&&"paid"===p&&"confirmed"===i.status){const e=await s.from("order_items").select("product_id, quantity").eq("order_id",n),r=e.error,t=e.data;if(r)console.error("Error obteniendo items para restaurar stock:",r);else if(t)for(const e of t){const r=(await s.rpc("adjust_product_stock",{p_id_product:e.product_id,p_delta:Number(e.quantity)})).error;r&&console.error("Error restaurando stock via RPC:",r)}}return{data:{success:!0,data:{id_order:y.id_order,payment_status:y.payment_status,payment_method:y.payment_method,notes:y.notes,updated_at:y.updated_at},message:`Estado de pago del pedido actualizado exitosamente a '${u}'`}}}catch(e){return console.error("Error en PATCH /api/orders/[id]/update-payment:",e),{data:{success:!1,error:"Error interno del servidor"}}}});export{d as default};
//# sourceMappingURL=update-payment.mjs.map
