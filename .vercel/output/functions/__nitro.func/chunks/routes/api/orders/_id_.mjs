import{d as r,g as e,s as o,h as t,b as i,r as n,a as s,k as d}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const a=r(async r=>{var a,u,c;const m=e(r),l=await o(r),p=t(r,"id");if(!p)return{success:!1,error:"ID de pedido requerido"};if("GET"===m)try{const{data:r,error:e}=await l.from("orders").select("\n          *,\n          customer:customers(\n            id_customer,\n            first_name,\n            last_name,\n            email,\n            phone,\n            address,\n            city,\n            state,\n            postal_code,\n            country\n          ),\n          order_items:order_items(\n            id_order_item,\n            quantity,\n            unit_price,\n            total_price,\n            product:products(\n              id_product,\n              name,\n              sku,\n              image_url,\n              price\n            )\n          )\n        ").eq("id_order",p).single();if(e)return"PGRST116"===e.code?{success:!1,error:"Pedido no encontrado"}:(console.error("Error obteniendo pedido:",e),{success:!1,error:"Error obteniendo pedido",details:e.message});const o=r,t={...o,customer_name:o.customer?`${o.customer.first_name} ${o.customer.last_name}`:"Cliente no encontrado",customer_email:(null==(a=o.customer)?void 0:a.email)||"N/A",customer_phone:(null==(u=o.customer)?void 0:u.phone)||"N/A",items_count:(null==(c=o.order_items)?void 0:c.length)||0,total_amount:o.total_amount||0,subtotal:o.subtotal||0};return i(t)}catch(r){return console.error("Error en GET /api/orders/[id]:",r),n("Error interno del servidor")}if("PUT"===m)try{await s(r);const e=await d(r);if(!e.customer_id||!e.order_items||0===e.order_items.length)return n("El cliente y al menos un item son requeridos");const{data:o,error:t}=await l.from("orders").select("id_order, status").eq("id_order",p).single();if(t||!o)return n("Pedido no encontrado");if("pending"!==o.status&&"confirmed"!==o.status)return n("Solo se pueden editar pedidos pendientes o confirmados");const{data:a,error:u}=await l.from("customers").select("id_customer, is_active").eq("id_customer",e.customer_id).single();if(u||!a)return n("Cliente no encontrado");if(!a.is_active)return n("El cliente está inactivo");const{data:c,error:m}=await l.from("order_items").select("product_id, quantity").eq("order_id",p);if(m&&console.error("Error obteniendo items actuales:",m),c)for(const r of c){const{error:e}=await l.from("products").update({stock_quantity:l.raw(`stock_quantity + ${r.quantity}`),updated_at:(new Date).toISOString()}).eq("id_product",r.product_id);e&&console.error("Error restaurando stock:",e)}let _=0;const f=[];for(const r of e.order_items){if(!r.product_id||!r.quantity||!r.unit_price)return n("Todos los items deben tener product_id, quantity y unit_price");const{data:e,error:o}=await l.from("products").select("id_product, name, stock_quantity, price").eq("id_product",r.product_id).single();if(o||!e)return n(`Producto ${r.product_id} no encontrado`);if(e.stock_quantity<r.quantity)return n(`Stock insuficiente para ${e.name}. Disponible: ${e.stock_quantity}, Solicitado: ${r.quantity}`);const t=Number(r.quantity)*Number(r.unit_price);_+=t,f.push({product_id:r.product_id,quantity:r.quantity,unit_price:r.unit_price,total_price:t})}const q=e.tax_amount||0,y=e.shipping_amount||0,E=_+q+y,g={customer_id:e.customer_id,total_amount:E,subtotal:_,tax_amount:q,shipping_amount:y,status:e.status||o.status,shipping_address:e.shipping_address||null,billing_address:e.billing_address||null,payment_method:e.payment_method||null,payment_status:e.payment_status||"pending",tracking_number:e.tracking_number||null,notes:e.notes||null,updated_at:(new Date).toISOString()},w=await l.from("orders").update(g).eq("id_order",p).select().single(),b=w.data,h=w.error;if(h)return console.error("Error actualizando pedido:",h),n("Error actualizando pedido",h.message);const{error:k}=await l.from("order_items").delete().eq("order_id",p);if(k)return console.error("Error eliminando items actuales:",k),n("Error eliminando items actuales",k.message);const v=f.map(r=>({...r,order_id:p})),{error:S}=await l.from("order_items").insert(v);if(S)return console.error("Error creando nuevos items:",S),n("Error creando nuevos items",S.message);for(const r of f){const{error:e}=await l.from("products").update({stock_quantity:l.raw(`stock_quantity - ${r.quantity}`),updated_at:(new Date).toISOString()}).eq("id_product",r.product_id);e&&console.error("Error actualizando stock:",e)}return i(b,"Pedido actualizado exitosamente")}catch(r){return console.error("Error en PUT /api/orders/[id]:",r),n("Error interno del servidor")}if("DELETE"===m)try{await s(r);const{data:e,error:o}=await l.from("orders").select("id_order, status").eq("id_order",p).single();if(o||!e)return n("Pedido no encontrado");if(!["pending","confirmed"].includes(e.status))return n("Solo se pueden eliminar pedidos en estado pending o confirmed");const{data:t,error:d}=await l.from("order_items").select("product_id, quantity").eq("order_id",p);if(d&&console.error("Error obteniendo items del pedido:",d),t)for(const r of t){const e=(await l.rpc("adjust_product_stock",{p_id_product:r.product_id,p_delta:Number(r.quantity)})).error;e&&console.error("Error restaurando stock via RPC:",e)}const{error:a}=await l.from("order_items").delete().eq("order_id",p);if(a)return console.error("Error eliminando items del pedido:",a),n("Error eliminando items del pedido",a.message);const{error:u}=await l.from("orders").delete().eq("id_order",p);return u?(console.error("Error eliminando pedido:",u),n("Error eliminando pedido",u.message)):i(null,"Pedido eliminado exitosamente")}catch(r){return console.error("Error en DELETE /api/orders/[id]:",r),n("Error interno del servidor")}return n("Método no permitido")});export{a as default};
//# sourceMappingURL=_id_.mjs.map
