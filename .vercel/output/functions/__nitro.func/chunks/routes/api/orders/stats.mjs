import{d as e,g as t,s as r,r as o,a,m as s,b as n}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const d=e(async e=>{const d=t(e),i=await r(e);if("GET"!==d)return o("Método no permitido");try{await a(e);const t=s(e),r=t.start_date?new Date(t.start_date):null,o=t.end_date?new Date(t.end_date):null,applyDateFilters=e=>(r&&(e=e.gte("created_at",r.toISOString())),o&&(e=e.lte("created_at",o.toISOString())),e),{count:d,error:l}=await applyDateFilters(i.from("orders").select("id_order",{count:"exact",head:!0}));if(l)return console.error("Error obteniendo total de pedidos:",l),{success:!1,error:"Error obteniendo estadísticas",details:l.message};const{data:u,error:c}=await applyDateFilters(i.from("orders").select("status")),m=u?u.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{}):null;c&&console.error("Error obteniendo pedidos por estado:",c);const{data:p,error:_}=await applyDateFilters(i.from("orders").select("payment_status")),v=p?p.reduce((e,t)=>(e[t.payment_status]=(e[t.payment_status]||0)+1,e),{}):null;_&&console.error("Error obteniendo pedidos por estado de pago:",_);const{data:f,error:g}=await applyDateFilters(i.from("orders").select("total_amount")),b=f?f.reduce((e,t)=>e+(t.total_amount||0),0):0;g&&console.error("Error obteniendo total de ventas:",g);const y=new Date(Date.now()-31536e6).toISOString(),{data:w,error:h}=await i.from("orders").select("created_at, total_amount").gte("created_at",y),E=w?(()=>{const e=w.reduce((e,t)=>{const r=new Date(t.created_at),o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;return e[o]||(e[o]={orders:0,sales:0}),e[o].orders+=1,e[o].sales+=t.total_amount||0,e},{});return Object.entries(e).map(([e,t])=>({month:e,...t})).sort((e,t)=>e.month.localeCompare(t.month))})():[];h&&console.error("Error obteniendo pedidos por mes:",h);const{data:S,error:O}=await i.from("order_items").select("quantity, product:products(name, sku)"),q=S?(()=>{const e=S.reduce((e,t)=>{var r,o;const a=(null==(r=t.product)?void 0:r.name)||"Producto desconocido",s=(null==(o=t.product)?void 0:o.sku)||"N/A",n=`${a} (${s})`;return e[n]||(e[n]={name:a,sku:s,quantity:0}),e[n].quantity+=t.quantity||0,e},{});return Object.values(e).sort((e,t)=>t.quantity-e.quantity).slice(0,10)})():[];O&&console.error("Error obteniendo productos más vendidos:",O);const{data:$,error:j}=await i.from("orders").select("customer_id, total_amount, customer:customers(first_name, last_name, email)"),D=$?(()=>{const e=$.reduce((e,t)=>{var r;const o=t.customer_id,a=t.customer?`${t.customer.first_name} ${t.customer.last_name}`:"Cliente desconocido",s=(null==(r=t.customer)?void 0:r.email)||"N/A";return e[o]||(e[o]={name:a,email:s,orders:0,total_spent:0}),e[o].orders+=1,e[o].total_spent+=t.total_amount||0,e},{});return Object.values(e).sort((e,t)=>t.total_spent-e.total_spent).slice(0,10)})():[];j&&console.error("Error obteniendo clientes más frecuentes:",j);const I=(null==m?void 0:m.pending)||0,k=(null==m?void 0:m.confirmed)||0,M=(null==m?void 0:m.shipped)||0,x=(null==m?void 0:m.delivered)||0,A=(null==m?void 0:m.cancelled)||0,C=(null==v?void 0:v.pending)||0,G=(null==v?void 0:v.paid)||0,N=(null==v?void 0:v.failed)||0,T=(null==v?void 0:v.refunded)||0,F=d||0,P=b||0,Y=F>0?P/F:0;return n({summary:{total_orders:F,total_sales:P,average_order_value:Math.round(100*Y)/100,pending_orders:I,confirmed_orders:k,shipped_orders:M,delivered_orders:x,cancelled_orders:A},payment_status:{pending:C,paid:G,failed:N,refunded:T},monthly_trends:E||[],top_products:q||[],top_customers:D||[],date_range:{start_date:(null==r?void 0:r.toISOString())||null,end_date:(null==o?void 0:o.toISOString())||null}})}catch(e){return console.error("Error en GET /api/orders/stats:",e),o("Error interno del servidor")}});export{d as default};
//# sourceMappingURL=stats.mjs.map
