import{d as t,g as r,s as e,r as o,c as i,e as s,k as n,b as a}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const d=t(async t=>{const d=r(t),u=await e(t);if("POST"!==d)return o("Método no permitido");try{await i(t);const r=await s(t);if(!r)return o("No autenticado");const e=await n(t);if(!e.customer_id||!e.order_items||0===e.order_items.length)return o("El cliente y al menos un item son requeridos");const{data:d,error:c}=await u.from("profiles").select("id, role, is_active").eq("id",r.id).single();if(c||!d)return o("Perfil no encontrado");if("user"!==d.role)return o("Solo usuarios con rol user pueden crear aquí");if(!1===d.is_active)return o("Usuario inactivo");const{data:p,error:m}=await u.from("customers").select("id_customer, is_active").eq("id_customer",e.customer_id).single();if(m||!p)return o("Cliente no encontrado");if(!1===p.is_active)return o("El cliente está inactivo");let _=0;const l=[],f=(new Date).toISOString(),{data:g}=await u.from("offers").select("product_id, discount_percent, is_active, valid_from, valid_to").eq("is_active",!0),y=new Map;for(const t of g||[]){const r=!t.valid_from||t.valid_from<=f,e=!t.valid_to||t.valid_to>=f;r&&e&&y.set(t.product_id,Number(t.discount_percent))}for(const t of e.order_items){if(!t.product_id||!t.quantity)return o("Todos los items deben tener product_id y quantity");const{data:r,error:e}=await u.from("products").select("id_product, name, stock_quantity, price").eq("id_product",t.product_id).single();if(e||!r)return o(`Producto ${t.product_id} no encontrado`);if(r.stock_quantity<t.quantity)return o(`Stock insuficiente para ${r.name}. Disponible: ${r.stock_quantity}, Solicitado: ${t.quantity}`);const i=Number(r.price),s=y.get(t.product_id)||0,n=Math.round(i*(1-s/100)*100)/100,a=Number(t.quantity)*n;_+=a,l.push({product_id:t.product_id,quantity:t.quantity,unit_price:n,total_price:a})}const q=e.tax_amount||0,v=e.shipping_amount||0,b=_+q+v,h={customer_id:e.customer_id,total_amount:b,subtotal:_,tax_amount:q,shipping_amount:v,status:"pending",shipping_address:e.shipping_address||null,billing_address:e.billing_address||null,payment_method:e.payment_method||null,payment_status:"pending",tracking_number:null,notes:e.notes||null,order_source:"user",assigned_user_id:r.id},w=await u.from("orders").insert(h).select().single(),S=w.data,k=w.error;if(k)return o("Error creando pedido",k.message);const E=l.map(t=>({...t,order_id:S.id_order})),{error:P}=await u.from("order_items").insert(E);return P?(await u.from("orders").delete().eq("id_order",S.id_order),o("Error creando items del pedido",P.message)):a(S,"Pedido creado exitosamente")}catch(t){return console.error("Error en POST /api/orders/create-from-user:",t),o("Error interno del servidor")}});export{d as default};
//# sourceMappingURL=create-from-user.mjs.map
