import{d as t,g as e,s as r,r as o,c as i,e as s,k as n,b as a}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const d=t(async t=>{const d=e(t),u=await r(t);if("POST"!==d)return o("Método no permitido");try{await i(t);const e=await s(t);if(!e)return o("No autenticado");const r=await n(t);if(!r.customer_id||!r.order_items||0===r.order_items.length)return o("El cliente y al menos un item son requeridos");const{data:d,error:c}=await u.from("profiles").select("id, role, is_active").eq("id",e.id).single();if(c||!d)return o("Perfil no encontrado");if(!["customer","user"].includes(d.role))return o("Solo clientes o usuarios pueden crear aquí");if(!1===d.is_active)return o("Usuario inactivo");const{data:m,error:p}=await u.from("customers").select("id_customer, is_active").eq("id_customer",r.customer_id).single();if(p||!m)return o("Cliente no encontrado");if(!1===m.is_active)return o("El cliente está inactivo");let l=0;const _=[];for(const t of r.order_items){if(!t.product_id||!t.quantity)return o("Todos los items deben tener product_id y quantity");const{data:e,error:r}=await u.from("products").select("id_product, name, stock_quantity, price").eq("id_product",t.product_id).single();if(r||!e)return o(`Producto ${t.product_id} no encontrado`);if(e.stock_quantity<t.quantity)return o(`Stock insuficiente para ${e.name}. Disponible: ${e.stock_quantity}, Solicitado: ${t.quantity}`);const i=Number(e.price),s=Number(t.quantity)*i;l+=s,_.push({product_id:t.product_id,quantity:t.quantity,unit_price:i,total_price:s})}const f=r.tax_amount||0,y=r.shipping_amount||0,g=l+f+y,q={customer_id:r.customer_id,total_amount:g,subtotal:l,tax_amount:f,shipping_amount:y,status:"pending",shipping_address:r.shipping_address||null,billing_address:r.billing_address||null,payment_method:r.payment_method||null,payment_status:"pending",tracking_number:null,notes:r.notes||null,order_source:"customer",assigned_user_id:null},b=await u.from("orders").insert(q).select().single(),h=b.data,w=b.error;if(w)return o("Error creando pedido",w.message);const v=_.map(t=>({...t,order_id:h.id_order})),{error:k}=await u.from("order_items").insert(v);return k?(await u.from("orders").delete().eq("id_order",h.id_order),o("Error creando items del pedido",k.message)):a(h,"Pedido creado exitosamente")}catch(t){return console.error("Error en POST /api/orders/create-from-customer:",t),o("Error interno del servidor")}});export{d as default};
//# sourceMappingURL=create-from-customer.mjs.map
