import{d as e,g as r,s as o,h as t,k as s}from"../../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const a=e(async e=>{const a=r(e),d=await o(e),i=t(e,"id");if("PATCH"!==a)return{data:{success:!1,error:"Método no permitido"}};if(!i)return{data:{success:!1,error:"ID de pedido requerido"}};try{const r=await s(e);if(!r.status)return{data:{success:!1,error:"El nuevo estado es requerido"}};const o=["pending","confirmed","shipped","delivered","cancelled"];if(!r.status||!o.includes(r.status))return{data:{success:!1,error:"Estado no válido. Estados permitidos: pending, confirmed, shipped, delivered, cancelled"}};const t=await d.from("orders").select("id_order, status, payment_status").eq("id_order",i).single(),a=t.error,n=t.data;if(a)return"PGRST116"===a.code?{data:{success:!1,error:"Pedido no encontrado"}}:(console.error("Error obteniendo pedido:",a),{data:{success:!1,error:"Error obteniendo pedido",details:a.message}});const c=n.status,u=r.status,p={pending:["confirmed","cancelled"],confirmed:["shipped","cancelled"],shipped:["delivered","cancelled"],delivered:[],cancelled:[]};if(!p[c].includes(u))return{data:{success:!1,error:`No se puede cambiar el estado de '${c}' a '${u}'. Transiciones permitidas: ${p[c].join(", ")}`}};if("shipped"===u&&!r.tracking_number)return{data:{success:!1,error:'El número de seguimiento es requerido cuando el estado cambia a "shipped"'}};if("confirmed"===u&&"paid"!==n.payment_status)return{data:{success:!1,error:"No se puede confirmar un pedido con estado de pago pendiente"}};const l={status:u,updated_at:(new Date).toISOString()};r.tracking_number&&(l.tracking_number=r.tracking_number.trim()),r.notes&&(l.notes=r.notes.trim());const m=await d.from("orders").update(l).eq("id_order",i).select("id_order, status, tracking_number, notes, updated_at").single(),f=m.error,_=m.data;if(f)return console.error("Error actualizando estado del pedido:",f),{data:{success:!1,error:"Error actualizando estado del pedido",details:f.message}};if("cancelled"===u&&"cancelled"!==c){const e=await d.from("order_items").select("product_id, quantity").eq("order_id",i),r=e.error,o=e.data;if(r)console.error("Error obteniendo items para restaurar stock:",r);else if(o)for(const e of o){const r=(await d.rpc("adjust_product_stock",{p_id_product:e.product_id,p_delta:Number(e.quantity)})).error;r&&console.error("Error restaurando stock via RPC:",r)}}if("confirmed"===u&&"pending"===c){const e=await d.from("order_items").select("product_id, quantity").eq("order_id",i),r=e.error,o=e.data;if(r)console.error("Error obteniendo items para verificar stock:",r);else if(o){for(const e of o){const r=await d.from("products").select("stock_quantity, name").eq("id_product",e.product_id).single(),o=r.error,t=r.data;if(o)console.error("Error verificando stock del producto:",o);else if(t.stock_quantity<e.quantity)return console.warn(`Stock insuficiente para ${t.name} al confirmar pedido`),{data:{success:!1,error:`Stock insuficiente para ${t.name}`}}}for(const e of o){const r=(await d.rpc("adjust_product_stock",{p_id_product:e.product_id,p_delta:-Number(e.quantity)})).error;r&&console.error("Error descontando stock via RPC:",r)}}}return{data:{success:!0,data:{id_order:_.id_order,status:_.status,tracking_number:_.tracking_number,notes:_.notes,updated_at:_.updated_at},message:`Estado del pedido actualizado exitosamente a '${u}'`}}}catch(e){return console.error("Error en PATCH /api/orders/[id]/update-status:",e),{data:{success:!1,error:"Error interno del servidor"}}}});export{a as default};
//# sourceMappingURL=update-status.mjs.map
