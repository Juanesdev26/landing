import{d as t,s as o,g as e,h as a,n as s,a as r,b as i,i as n,j as d,k as c,r as u}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const p=t(async t=>{var p;const m=await o(t),l=e(t),f=a(t,"id");if(!f)throw s({statusCode:400,statusMessage:"ID de producto requerido"});try{switch(l){case"GET":const{data:o,error:e}=await m.from("products").select("\n            *,\n            category:categories(name)\n          ").eq("id_product",f).single();if(e){if("PGRST116"===e.code)throw s({statusCode:404,statusMessage:"Producto no encontrado"});throw e}return i(o);case"PUT":await r(t);const a=n(t,"content-type")||"";let u={},l=null;if(a.includes("multipart/form-data")){const o=await d(t),e={};let a=null;for(const t of o||[])"file"===t.type?"image"===t.name&&t.data&&t.filename&&(a=t):t.name&&(e[t.name]=(null==(p=t.data)?void 0:p.toString())||"");if(u=e,a){const t=a.filename.split(".").pop(),o=`${crypto.randomUUID()}.${t}`,{error:e}=await m.storage.from("product-image").upload(o,a.data,{contentType:a.mimetype,upsert:!1});if(e)throw s({statusCode:400,statusMessage:"Error subiendo imagen"});const{data:r}=m.storage.from("product-image").getPublicUrl(o);l=r.publicUrl}}else u=await c(t);const g=["name","description","price","stock_quantity","category_id","sku"];for(const t of g)if(!u[t])throw s({statusCode:400,statusMessage:`Campo requerido: ${t}`});const{data:w,error:h}=await m.from("products").update({name:u.name,description:u.description,price:parseFloat(u.price),stock_quantity:parseInt(u.stock_quantity),category_id:u.category_id,brand:u.brand||"",sku:u.sku,image_url:l||u.image_url||null,is_active:void 0===u.is_active||u.is_active,updated_at:(new Date).toISOString()}).eq("id_product",f).select().single();if(h){if("PGRST116"===h.code)throw s({statusCode:404,statusMessage:"Producto no encontrado"});throw h}return i(w,"Producto actualizado exitosamente");case"DELETE":await r(t);const{error:y}=await m.from("products").delete().eq("id_product",f);if(y){if("PGRST116"===y.code)throw s({statusCode:404,statusMessage:"Producto no encontrado"});throw y}return i(null,"Producto eliminado exitosamente");default:throw s({statusCode:405,statusMessage:"MÃ©todo no permitido"})}}catch(t){if(console.error("Error en API de producto individual:",t),t.statusCode)throw t;return u(t.statusMessage||t.message||"Error interno del servidor")}});export{p as default};
//# sourceMappingURL=_id_.mjs.map
