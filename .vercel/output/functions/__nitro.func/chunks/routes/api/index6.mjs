import{d as r,g as e,s as t,a as o,f as n,b as i,r as s,k as a}from"../../_/nitro.mjs";import{createClient as d}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const u=r(async r=>{const u=e(r),c=await t(r);if("GET"===u)try{await o(r);const e=n(),t=d(e.public.supabaseUrl,e.supabaseServiceKey,{auth:{persistSession:!1}}),{data:s,error:a}=await t.from("orders").select("\n          *,\n          customer:customers(\n            id_customer,\n            first_name,\n            last_name,\n            email,\n            phone\n          ),\n          order_items:order_items(\n            id_order_item,\n            quantity,\n            unit_price,\n            total_price,\n            product:products(\n              id_product,\n              name,\n              sku,\n              image_url,\n              price\n            )\n          )\n        ").order("created_at",{ascending:!1}).limit(500);if(a)return console.error("Error obteniendo pedidos:",a),{data:{success:!1,error:"Error obteniendo pedidos",details:a.message}};const u=s.map(r=>{var e,t;return{...r,customer_name:r.customer?`${r.customer.first_name} ${r.customer.last_name}`:"Cliente no encontrado",customer_email:(null==(e=r.customer)?void 0:e.email)||"N/A",customer_phone:(null==(t=r.customer)?void 0:t.phone)||"N/A",items_count:(r.order_items||[]).reduce((r,e)=>r+Number(e.quantity||0),0),total_amount:Number(r.total_amount||(r.order_items||[]).reduce((r,e)=>r+Number(e.total_price||Number(e.quantity||0)*Number(e.unit_price||0)),0)),subtotal:Number(r.subtotal||0)}});return i(u)}catch(r){return console.error("Error en GET /api/orders:",r),s("Error interno del servidor")}if("POST"===u)try{await o(r);const e=await a(r);if(!e.customer_id||!e.order_items||0===e.order_items.length)return s("El cliente y al menos un item son requeridos");const{data:t,error:n}=await c.from("customers").select("id_customer, is_active").eq("id_customer",e.customer_id).single();if(n||!t)return s("Cliente no encontrado");if(!t.is_active)return s("El cliente está inactivo");let d=0;const u=[];for(const r of e.order_items){if(!r.product_id||!r.quantity||!r.unit_price)return s("Todos los items deben tener product_id, quantity y unit_price");const{data:e,error:t}=await c.from("products").select("id_product, name, stock_quantity, price").eq("id_product",r.product_id).single();if(t||!e)return s(`Producto ${r.product_id} no encontrado`);if(e.stock_quantity<r.quantity)return s(`Stock insuficiente para ${e.name}. Disponible: ${e.stock_quantity}, Solicitado: ${r.quantity}`);const o=Number(r.quantity)*Number(r.unit_price);d+=o,u.push({product_id:r.product_id,quantity:r.quantity,unit_price:r.unit_price,total_price:o})}const m=e.tax_amount||0,_=e.shipping_amount||0,p=d+m+_,l={customer_id:e.customer_id,total_amount:p,subtotal:d,tax_amount:m,shipping_amount:_,status:e.status||"pending",shipping_address:e.shipping_address||null,billing_address:e.billing_address||null,payment_method:e.payment_method||null,payment_status:e.payment_status||"pending",tracking_number:e.tracking_number||null,notes:e.notes||null,order_source:"admin",assigned_user_id:e.assigned_user_id||null},f=await c.from("orders").insert(l).select().single(),y=f.data,b=f.error;if(b)return console.error("Error creando pedido:",b),s("Error creando pedido",b.message);const g=u.map(r=>({...r,order_id:y.id_order})),{error:q}=await c.from("order_items").insert(g);if(q)return console.error("Error creando items del pedido:",q),await c.from("orders").delete().eq("id_order",y.id_order),s("Error creando items del pedido",q.message);for(const r of u){const{error:e}=await c.from("products").update({stock_quantity:c.raw(`stock_quantity - ${r.quantity}`),updated_at:(new Date).toISOString()}).eq("id_product",r.product_id);e&&console.error("Error actualizando stock:",e)}const{data:h,error:E}=await c.from("orders").select("\n          *,\n          customer:customers(\n            id_customer,\n            first_name,\n            last_name,\n            email,\n            phone\n          ),\n          order_items:order_items(\n            id_order_item,\n            quantity,\n            unit_price,\n            total_price,\n            product:products(\n              id_product,\n              name,\n              sku,\n              image_url\n            )\n          )\n        ").eq("id_order",y.id_order).single();return E&&console.error("Error obteniendo pedido completo:",E),i(h||y,"Pedido creado exitosamente")}catch(r){return console.error("Error en POST /api/orders:",r),s("Error interno del servidor")}return s("Método no permitido")});export{u as default};
//# sourceMappingURL=index6.mjs.map
