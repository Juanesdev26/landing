import{d as r,g as o,h as e,s as t,b as a,r as i,a as n,i as s,j as c,k as d}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const l=r(async r=>{var l,u,p,m;const g=o(r),f=e(r,"id"),E=await t(r);if(!f)return{success:!1,error:"ID de categoría requerido",data:null};if("GET"===g)try{const{data:r,error:o}=await E.from("categories").select("\n          *,\n          products:products(count)\n        ").eq("id_category",f).single();if(o)return"PGRST116"===o.code?{success:!1,error:"Categoría no encontrada",data:null}:(console.error("Error obteniendo categoría:",o),{success:!1,error:"Error obteniendo categoría",data:null});const e={...r,product_count:(null==(u=null==(l=null==r?void 0:r.products)?void 0:l[0])?void 0:u.count)||0};return a(e)}catch(r){return console.error("Error inesperado:",r),i("Error interno del servidor")}if("PUT"===g)try{await n(r);const o=s(r,"content-type")||"";let e={},t=null;if(o.includes("multipart/form-data")){const o=await c(r),a={};let i=null;for(const r of o||[])"file"===r.type?"image"===r.name&&r.data&&r.filename&&(i=r):r.name&&(a[r.name]=(null==(p=r.data)?void 0:p.toString())||"");if(e=a,i){const r=i.filename.split(".").pop(),o=`${crypto.randomUUID()}.${r}`,{error:e}=await E.storage.from("product-image").upload(o,i.data,{contentType:i.mimetype,upsert:!1});if(!e){const{data:r}=E.storage.from("product-image").getPublicUrl(o);t=r.publicUrl}}}else e=await d(r);if(!e.name||!e.name.trim())return i("El nombre de la categoría es obligatorio");const{data:l,error:u}=await E.from("categories").select("id_category").eq("name",e.name.trim()).neq("id_category",f).single();if(l)return i("Ya existe otra categoría con ese nombre");const g={name:e.name.trim(),description:(null==(m=e.description)?void 0:m.trim())||null,image_url:t||e.image_url||null,is_active:void 0===e.is_active||e.is_active,updated_at:(new Date).toISOString()},{data:v,error:y}=await E.from("categories").update(g).eq("id_category",f).select().single();return y?(console.error("Error actualizando categoría:",y),i("Error actualizando categoría")):a({...v,product_count:0})}catch(r){return console.error("Error inesperado:",r),i("Error interno del servidor")}if("DELETE"===g)try{await n(r);const{data:o,error:e}=await E.from("products").select("id_product").eq("category_id",f).limit(1);if(e)return console.error("Error verificando productos:",e),i("Error verificando productos asociados");if(o&&o.length>0)return i("No se puede eliminar la categoría porque tiene productos asociados");const{error:t}=await E.from("categories").delete().eq("id_category",f);return t?(console.error("Error eliminando categoría:",t),i("Error eliminando categoría")):a(null)}catch(r){if(null==r?void 0:r.statusCode)throw r;return console.error("Error inesperado:",r),i("Error interno del servidor")}return i("Método no permitido")});export{l as default};
//# sourceMappingURL=_id_.mjs.map
