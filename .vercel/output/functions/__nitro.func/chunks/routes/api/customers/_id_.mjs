import{d as e,g as r,s as o,h as s,a as t,k as i}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const n=e(async e=>{var n,a,c,l,d,u,m;const p=r(e),f=await o(e),_=s(e,"id");if(!_)return{success:!1,error:"ID de cliente requerido"};if("GET"===p)try{const{data:e,error:r}=await f.from("customers").select("*").eq("id_customer",_).single();if(r)return"PGRST116"===r.code?{success:!1,error:"Cliente no encontrado"}:(console.error("Error obteniendo cliente:",r),{success:!1,error:"Error obteniendo cliente",details:r.message});const{count:o}=await f.from("orders").select("id_order",{count:"exact",head:!0}).eq("customer_id",_);return{success:!0,data:{...e,order_count:o||0}}}catch(e){return console.error("Error en GET /api/customers/[id]:",e),{success:!1,error:"Error interno del servidor"}}if("PUT"===p){await t(e);try{const r=await i(e);if(!r.first_name||!r.last_name||!r.email)return{success:!1,error:"Los campos nombre, apellido y email son requeridos"};const{data:o,error:s}=await f.from("customers").select("id_customer").eq("email",r.email).neq("id_customer",_).single();if(s&&"PGRST116"!==s.code)return console.error("Error verificando email duplicado:",s),{success:!1,error:"Error verificando email duplicado"};if(o)return{success:!1,error:"Ya existe otro cliente con este email"};const t={first_name:r.first_name.trim(),last_name:r.last_name.trim(),email:r.email.trim().toLowerCase(),phone:(null==(n=r.phone)?void 0:n.trim())||null,address:(null==(a=r.address)?void 0:a.trim())||null,city:(null==(c=r.city)?void 0:c.trim())||null,state:(null==(l=r.state)?void 0:l.trim())||null,postal_code:(null==(d=r.postal_code)?void 0:d.trim())||null,country:(null==(u=r.country)?void 0:u.trim())||null,birth_date:r.birth_date||null,gender:r.gender||null,notes:(null==(m=r.notes)?void 0:m.trim())||null,is_active:void 0===r.is_active||r.is_active,updated_at:(new Date).toISOString()},{data:p,error:E}=await f.from("customers").update(t).eq("id_customer",_).select().single();return E?(console.error("Error actualizando cliente:",E),{success:!1,error:"Error actualizando cliente",details:E.message}):{success:!0,data:p,message:"Cliente actualizado exitosamente"}}catch(e){return console.error("Error en PUT /api/customers/[id]:",e),{success:!1,error:"Error interno del servidor"}}}if("DELETE"===p){await t(e);try{const{data:e,error:r}=await f.from("orders").select("id_order").eq("customer_id",_).limit(1);if(r)return console.error("Error verificando pedidos del cliente:",r),{success:!1,error:"Error verificando pedidos del cliente"};if(e&&e.length>0)return{success:!1,error:"No se puede eliminar el cliente porque tiene pedidos asociados"};const{error:o}=await f.from("customers").delete().eq("id_customer",_);return o?(console.error("Error eliminando cliente:",o),{success:!1,error:"Error eliminando cliente",details:o.message}):{success:!0,message:"Cliente eliminado exitosamente"}}catch(e){return console.error("Error en DELETE /api/customers/[id]:",e),{success:!1,error:"Error interno del servidor"}}}return{success:!1,error:"MÃ©todo no permitido"}});export{n as default};
//# sourceMappingURL=_id_.mjs.map
