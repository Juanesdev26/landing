import{d as r,g as e,s as o,h as i,b as s,r as a,a as n,k as t,f as l}from"../../../_/nitro.mjs";import{createClient as d}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const u=r(async r=>{var u,c,m,f,p,E,_,v,g,w,h,b,y;const q=e(r),S=await o(r),T=i(r,"id");if(!T)return{success:!1,error:"ID de usuario requerido"};if("GET"===q)try{const{data:r,error:e}=await S.from("profiles").select("*").eq("id",T).single();if(e)return"PGRST116"===e.code?{success:!1,error:"Usuario no encontrado"}:(console.error("Error obteniendo perfil:",e),{success:!1,error:"Error obteniendo perfil",details:e.message});const o={...r,full_name:`${r.first_name||""} ${r.last_name||""}`.trim()||null};return s(o)}catch(r){return console.error("Error en GET /api/profiles/[id]:",r),a("Error interno del servidor")}if("PUT"===q)try{await n(r);const e=await t(r);if(!(e.first_name&&e.last_name&&e.email&&e.role))return a("Los campos nombre, apellido, email y rol son requeridos");const{data:o,error:i}=await S.from("profiles").select("id").eq("email",e.email).neq("id",T).single();if(i&&"PGRST116"!==i.code)return console.error("Error verificando email duplicado:",i),a("Error verificando email duplicado");if(o)return a("Ya existe otro usuario con este email");const l={first_name:e.first_name.trim(),last_name:e.last_name.trim(),email:e.email.trim().toLowerCase(),phone:(null==(u=e.phone)?void 0:u.trim())||null,address:(null==(c=e.address)?void 0:c.trim())||null,city:(null==(m=e.city)?void 0:m.trim())||null,state:(null==(f=e.state)?void 0:f.trim())||null,postal_code:(null==(p=e.postal_code)?void 0:p.trim())||null,country:(null==(E=e.country)?void 0:E.trim())||null,birth_date:e.birth_date||null,gender:e.gender||null,role:e.role,is_active:void 0===e.is_active||e.is_active,notes:(null==(_=e.notes)?void 0:_.trim())||null,updated_at:(new Date).toISOString()},{data:d,error:v}=await S.from("profiles").update(l).eq("id",T).select().single();return v?(console.error("Error actualizando perfil:",v),{success:!1,error:"Error actualizando perfil",details:v.message}):s(d,"Perfil actualizado exitosamente")}catch(r){return console.error("Error en PUT /api/profiles/[id]:",r),a("Error interno del servidor")}if("DELETE"===q)try{await n(r);const e=l(),o=d(e.public.supabaseUrl,e.supabaseServiceKey,{auth:{persistSession:!1}}),i=await o.auth.admin.deleteUser(T);if(i.error&&(null==(v=i.error)?void 0:v.message)&&!(null==(w=null==(g=i.error)?void 0:g.message)?void 0:w.includes("not found"))){const r=i.error;console.warn("No se pudo eliminar auth user en primer intento, continuando:",r)}const t=await o.from("customers").update({user_id:null,updated_at:(new Date).toISOString()}).eq("user_id",T);if(t.error)return console.error("Error desasociando cliente del usuario:",t.error),a("Error desasociando cliente del usuario",t.error.message);const u=await o.from("reservations").delete().eq("user_id",T);if(u.error)return console.error("Error eliminando reservas del usuario:",u.error),a("Error eliminando reservas del usuario",u.error.message);const c=await o.from("user_offers").delete().eq("user_id",T);if(c.error)return console.error("Error eliminando ofertas del usuario:",c.error),a("Error eliminando ofertas del usuario",c.error.message);const m=await o.from("orders").update({assigned_user_id:null,updated_at:(new Date).toISOString()}).eq("assigned_user_id",T);if(m.error)return console.error("Error desasociando órdenes asignadas:",m.error),a("Error desasociando órdenes asignadas",m.error.message);const f=await o.from("profiles").delete().eq("id",T);if(f.error)return console.error("Error eliminando perfil:",f.error),a("Error eliminando perfil",f.error.message);const p=await o.auth.admin.deleteUser(T);if(p.error&&(null==(h=p.error)?void 0:h.message)&&!(null==(y=null==(b=p.error)?void 0:b.message)?void 0:y.includes("not found"))){const r=p.error;return console.error("Error eliminando usuario de Auth:",r),a("Error eliminando usuario del sistema de autenticación",r.message)}return s(null,"Usuario eliminado exitosamente")}catch(r){return console.error("Error en DELETE /api/profiles/[id]:",r),a("Error interno del servidor")}return a("Método no permitido")});export{u as default};
//# sourceMappingURL=_id_.mjs.map
