import{d as r,g as e,s as o,l as t,b as a,a as n,i,j as s,k as c,r as d}from"../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const l=r(async r=>{var l,m;const p=e(r),u=await o(r);if("GET"===p)try{t(r,"Cache-Control","public, max-age=60");const{data:e,error:o}=await u.from("categories").select("*").eq("is_active",!0).order("name");if(o)return console.error("Error obteniendo categorías:",o),{data:{success:!1,error:"Error obteniendo categorías"}};const{data:n,error:i}=await u.from("categories").select("\n          *,\n          products:products(count)\n        ").eq("is_active",!0).order("name");i&&console.error("Error obteniendo conteos de productos por categoría:",i);const s=(n||e).map(r=>{var e,o;return{...r,product_count:(null==(o=null==(e=null==r?void 0:r.products)?void 0:e[0])?void 0:o.count)||0}});return a(s)}catch(r){return console.error("Error inesperado:",r),{data:{success:!1,error:"Error interno del servidor"}}}if("POST"===p)try{await n(r);const e=i(r,"content-type")||"";let o={},t=null;if(e.includes("multipart/form-data")){const e=await s(r),a={};let n=null;for(const r of e||[])"file"===r.type?"image"===r.name&&r.data&&r.filename&&(n=r):r.name&&(a[r.name]=(null==(l=r.data)?void 0:l.toString())||"");if(o=a,n){const r=n.filename.split(".").pop(),e=`${crypto.randomUUID()}.${r}`,{error:o}=await u.storage.from("product-image").upload(e,n.data,{contentType:n.mimetype,upsert:!1});if(!o){const{data:r}=u.storage.from("product-image").getPublicUrl(e);t=r.publicUrl}}}else o=await c(r);if(!o.name||!o.name.trim())return d("El nombre de la categoría es obligatorio");const{data:p,error:g}=await u.from("categories").select("id_category").eq("name",o.name.trim()).single();if(p)return d("Ya existe una categoría con ese nombre");const f={name:o.name.trim(),description:(null==(m=o.description)?void 0:m.trim())||null,image_url:t||o.image_url||null,is_active:void 0===o.is_active||o.is_active},{data:v,error:b}=await u.from("categories").insert(f).select().single();return b?(console.error("Error creando categoría:",b),d("Error creando categoría")):a({...v,product_count:0},"Categoría creada exitosamente")}catch(r){return console.error("Error inesperado:",r),d("Error interno del servidor")}return d("Método no permitido")});export{l as default};
//# sourceMappingURL=index.mjs.map
