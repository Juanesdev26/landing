import{d as r,g as e,s as t,a as o,k as s}from"../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const a=r(async r=>{var a,i,n,c,d,l,m;const u=e(r),p=await t(r);if("GET"===u)try{const{data:r,error:e}=await p.from("customers").select("*").order("created_at",{ascending:!1});if(e)return console.error("Error obteniendo clientes:",e),{data:{success:!1,error:"Error obteniendo clientes",details:e.message}};const t=(r||[]).map(r=>r.id_customer);let o={};if(t.length>0){const{data:r}=await p.from("orders").select("customer_id").in("customer_id",t);for(const e of r||[])o[e.customer_id]=(o[e.customer_id]||0)+1}return{data:{success:!0,data:(r||[]).map(r=>({...r,order_count:o[r.id_customer]||0}))}}}catch(r){return console.error("Error en GET /api/customers:",r),{data:{success:!1,error:"Error interno del servidor"}}}if("POST"===u){await o(r);try{const e=await s(r);if(!e.first_name||!e.last_name||!e.email)return{data:{success:!1,error:"Los campos nombre, apellido y email son requeridos"}};const{data:t,error:o}=await p.from("customers").select("id_customer").eq("email",e.email).single();if(o&&"PGRST116"!==o.code)return console.error("Error verificando email duplicado:",o),{data:{success:!1,error:"Error verificando email duplicado"}};if(t)return{data:{success:!1,error:"Ya existe un cliente con este email"}};const u={first_name:e.first_name.trim(),last_name:e.last_name.trim(),email:e.email.trim().toLowerCase(),phone:(null==(a=e.phone)?void 0:a.trim())||null,address:(null==(i=e.address)?void 0:i.trim())||null,city:(null==(n=e.city)?void 0:n.trim())||null,state:(null==(c=e.state)?void 0:c.trim())||null,postal_code:(null==(d=e.postal_code)?void 0:d.trim())||null,country:(null==(l=e.country)?void 0:l.trim())||null,birth_date:e.birth_date||null,gender:e.gender||null,notes:(null==(m=e.notes)?void 0:m.trim())||null,is_active:void 0===e.is_active||e.is_active},{data:f,error:_}=await p.from("customers").insert(u).select().single();return _?(console.error("Error creando cliente:",_),{data:{success:!1,error:"Error creando cliente",details:_.message}}):{data:{success:!0,data:f,message:"Cliente creado exitosamente"}}}catch(r){return console.error("Error en POST /api/customers:",r),{data:{success:!1,error:"Error interno del servidor"}}}}return{data:{success:!1,error:"MÃ©todo no permitido"}}});export{a as default};
//# sourceMappingURL=index2.mjs.map
