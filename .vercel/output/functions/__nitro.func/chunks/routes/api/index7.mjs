import{d as t,s as e,g as a,n as r,a as o,i as s,j as i,k as n,b as c,m as d,r as p}from"../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const m=t(async t=>{var m;const u=await e(t),g=a(t);try{switch(g){case"GET":const e=d(t),a=e.category_id?String(e.category_id):void 0,p=e.search?String(e.search):void 0,g=e.page?Math.max(1,parseInt(String(e.page))):void 0,l=e.page_size?Math.max(1,parseInt(String(e.page_size))):void 0;let f=u.from("products").select("\n            *,\n            category:categories(name)\n          ").order("created_at",{ascending:!1});if(a&&(f=f.eq("category_id",a)),p&&p.trim()){const t=`%${p.trim()}%`;f=f.or(`name.ilike.${t},sku.ilike.${t}`)}if(g&&l){const t=(g-1)*l,e=t+l-1;f=f.range(t,e)}const{data:_,error:y}=await f;if(y)throw y;return c(_);case"POST":await o(t);const w=s(t,"content-type")||"";let h={},v=null;if(w.includes("multipart/form-data")){const e=await i(t),a={};let o=null;for(const t of e||[])"file"===t.type?"image"===t.name&&t.data&&t.filename&&(o=t):t.name&&(a[t.name]=(null==(m=t.data)?void 0:m.toString())||"");if(h=a,o){const t=o.filename.split(".").pop(),e=`${crypto.randomUUID()}.${t}`,{error:a}=await u.storage.from("product-image").upload(e,o.data,{contentType:o.mimetype,upsert:!1});if(a)throw r({statusCode:400,statusMessage:"Error subiendo imagen"});const{data:s}=u.storage.from("product-image").getPublicUrl(e);v=s.publicUrl}}else h=await n(t);const b=["name","description","price","stock_quantity","category_id","sku"];for(const t of b)if(!h[t])throw r({statusCode:400,statusMessage:`Campo requerido: ${t}`});const k=crypto.randomUUID(),{data:S,error:I}=await u.from("products").insert({id_product:k,name:h.name,description:h.description,price:parseFloat(h.price),stock_quantity:parseInt(h.stock_quantity),category_id:h.category_id,brand:h.brand||"",sku:h.sku,image_url:v||h.image_url||null,is_active:void 0===h.is_active||h.is_active,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}).select().single();if(I)throw I;return c(S,"Producto creado exitosamente");default:throw r({statusCode:405,statusMessage:"MÃ©todo no permitido"})}}catch(t){return console.error("Error en API de productos:",t),p(t.statusMessage||t.message||"Error interno del servidor")}});export{m as default};
//# sourceMappingURL=index7.mjs.map
