import{d as e,g as r,s as t,r as o,c as i,e as n,k as a,b as s}from"../../../_/nitro.mjs";import{Preference as d,MercadoPagoConfig as c}from"mercadopago";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const u=new d(new c({accessToken:process.env.MERCADOPAGO_ACCESS_TOKEN||"TEST-...",options:{timeout:5e3}})),p=e(async e=>{const d=r(e),c=await t(e);if("POST"!==d)return o("Método no permitido");try{await i(e);const r=await n(e);if(!r)return o("No autenticado");const t=await a(e);if(!t.customer_id||!t.order_items||0===t.order_items.length)return o("El cliente y al menos un item son requeridos");const{data:d,error:p}=await c.from("profiles").select("id, role, is_active").eq("id",r.id).single();if(p||!d)return o("Perfil no encontrado");if(!["customer","user"].includes(d.role))return o("Solo clientes o usuarios pueden crear pedidos");if(!1===d.is_active)return o("Usuario inactivo");const{data:_,error:m}=await c.from("customers").select("id_customer, name, email, phone, is_active").eq("id_customer",t.customer_id).single();if(m||!_)return o("Cliente no encontrado");if(!1===_.is_active)return o("El cliente está inactivo");let l=0;const f=[];for(const e of t.order_items){if(!e.product_id||!e.quantity)return o("Todos los items deben tener product_id y quantity");const{data:r,error:t}=await c.from("products").select("id_product, name, stock_quantity, price, image_url").eq("id_product",e.product_id).single();if(t||!r)return o(`Producto ${e.product_id} no encontrado`);if(r.stock_quantity<e.quantity)return o(`Stock insuficiente para ${r.name}. Disponible: ${r.stock_quantity}, Solicitado: ${e.quantity}`);const i=Number(r.price);l+=Number(e.quantity)*i,f.push({id:e.product_id,title:r.name,description:`SKU: ${r.sku||e.product_id}`,category_id:"fashion",quantity:e.quantity,currency_id:"COP",unit_price:i,picture_url:r.image_url||void 0})}const g=t.tax_amount||0,h=t.shipping_amount||0,y=l+g+h,q={customer_id:t.customer_id,total_amount:y,subtotal:l,tax_amount:g,shipping_amount:h,status:"pending",shipping_address:t.shipping_address||null,billing_address:t.shipping_address||null,payment_method:"mercadopago",payment_status:"pending",tracking_number:null,notes:"Pago pendiente con MercadoPago",order_source:"customer",assigned_user_id:null},b=await c.from("orders").insert(q).select().single(),v=b.data,w=b.error;if(w)return o("Error creando pedido",w.message);const E=t.order_items.map(e=>({product_id:e.product_id,quantity:e.quantity,unit_price:e.unit_price,total_price:e.quantity*e.unit_price,order_id:v.id_order})),{error:P}=await c.from("order_items").insert(E);if(P)return await c.from("orders").delete().eq("id_order",v.id_order),o("Error creando items del pedido",P.message);const T={items:f,payer:{name:_.name||"Cliente",email:_.email||r.email||"",phone:{number:_.phone||""}},back_urls:{success:`${process.env.NUXT_PUBLIC_SITE_URL||"http://localhost:3000"}/checkout/success?order_id=${v.id_order}`,failure:`${process.env.NUXT_PUBLIC_SITE_URL||"http://localhost:3000"}/shop/cart?error=payment_failed`,pending:`${process.env.NUXT_PUBLIC_SITE_URL||"http://localhost:3000"}/checkout/pending?order_id=${v.id_order}`},auto_return:"approved",notification_url:`${process.env.NUXT_PUBLIC_SITE_URL||"http://localhost:3000"}/api/mercadopago/webhook`,external_reference:v.id_order,metadata:{order_id:v.id_order,customer_id:t.customer_id}},U=await u.create({body:T});return await c.from("orders").update({payment_reference:U.id,notes:`MercadoPago Preference: ${U.id}`}).eq("id_order",v.id_order),s({preference_id:U.id,init_point:U.init_point,sandbox_init_point:U.sandbox_init_point,order_id:v.id_order},"Preferencia de pago creada exitosamente")}catch(e){return console.error("Error en POST /api/mercadopago/create-preference:",e),o("Error interno del servidor",e.message||"Error desconocido")}});export{p as default};
//# sourceMappingURL=create-preference.mjs.map
