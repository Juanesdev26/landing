import{d as e,g as o,n as r,k as a,s as t}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const n=e(async e=>{if("POST"!==o(e))return r({statusCode:405,statusMessage:"MÃ©todo no permitido"});const n=await a(e),s=await t(e);console.log("ğŸ”” Webhook de MercadoPago recibido:",n);try{const{id:e,type:o}=n;if(!e||!o)return console.log("âŒ Webhook sin ID o tipo vÃ¡lido"),{received:!0};const r=process.env.MERCADOPAGO_ACCESS_TOKEN;if(!r)return console.error("âŒ MERCADOPAGO_ACCESS_TOKEN no configurado"),{received:!0};const a=await fetch(`https://api.mercadopago.com/v1/payments/${e}`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(!a.ok)return console.error("âŒ Error obteniendo detalles del pago desde MercadoPago"),{received:!0};const t=await a.json();console.log("ğŸ’³ Datos del pago:",t);const d=t.external_reference;if(!d)return console.log("âŒ No se encontrÃ³ external_reference en el pago"),{received:!0};const{data:i,error:c}=await s.from("orders").select("id_order, payment_status, total_amount").eq("id_order",d).single();if(c||!i)return console.error("âŒ Pedido no encontrado:",d),{received:!0};let p="pending";switch(t.status){case"approved":p="paid",console.log("âœ… Pago aprobado:",d);break;case"rejected":p="failed",console.log("âŒ Pago rechazado:",d);break;case"pending":p="pending",console.log("â³ Pago pendiente:",d);break;case"cancelled":p="failed",console.log("ğŸš« Pago cancelado:",d);break;default:return console.log("â“ Estado de pago desconocido:",t.status),{received:!0}}const{error:l}=await s.from("orders").update({payment_status:p,payment_method:"mercadopago",updated_at:(new Date).toISOString(),notes:`Estado: ${t.status}, Payment ID: ${e}, MercadoPago`}).eq("id_order",d);return l?console.error("âŒ Error actualizando estado de pago:",l):console.log(`âœ… Estado de pago actualizado a "${p}" para pedido:`,d),{received:!0}}catch(e){return console.error("âŒ Error procesando webhook de MercadoPago:",e),{received:!0}}});export{n as default};
//# sourceMappingURL=webhook.mjs.map
