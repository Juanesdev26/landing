import{d as e,g as r,s as t,h as i,r as o,a as s,b as a}from"../../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const n=e(async e=>{var n,d;const u=r(e),l=await t(e),m=i(e,"id");if("POST"!==u)return o("Método no permitido");if(!m)return o("ID de reserva requerido");try{await s(e);const r=await l.from("reservations").select("\n        *,\n        user:profiles(id, email, first_name, last_name, is_active),\n        product:products(id_product, name, price, sku)\n      ").eq("id_reservation",m).single(),t=r.error,i=r.data;if(t||!i)return o("Reserva no encontrada");if("pending"!==i.status)return o("La reserva no está pendiente");const u=await l.from("customers").select("id_customer").eq("user_id",i.user_id).single();let c=null==(n=u.data)?void 0:n.id_customer;if(!u.data||u.error){const e=i.user,r=await l.from("customers").insert({user_id:i.user_id,first_name:(null==e?void 0:e.first_name)||"Cliente",last_name:(null==e?void 0:e.last_name)||"N/A",email:(null==e?void 0:e.email)||null,is_active:!0}).select("id_customer").single();if(r.error)return o("Error creando cliente");c=r.data.id_customer}if(!c)return o("No fue posible obtener/crear el cliente");const p=Number(i.quantity),_=Number((null==(d=i.product)?void 0:d.price)||0),f=_*p,v={customer_id:c,total_amount:f,subtotal:f,tax_amount:0,shipping_amount:0,status:"pending",shipping_address:null,billing_address:null,payment_method:null,payment_status:"pending",tracking_number:null,notes:`Creado desde reserva ${m}`,order_source:"admin",assigned_user_id:null},g=await l.from("orders").insert(v).select().single();if(g.error)return o("Error creando pedido",g.error.message);const b=g.data,w={order_id:b.id_order,product_id:i.product_id,quantity:p,unit_price:_,total_price:_*p},h=await l.from("order_items").insert(w);return h.error?(await l.from("orders").delete().eq("id_order",b.id_order),o("Error creando items del pedido",h.error.message)):(await l.from("reservations").update({status:"converted",updated_at:(new Date).toISOString()}).eq("id_reservation",m),a(b,"Pedido creado desde reserva"))}catch(e){return console.error("Error en POST /api/reservations/[id]/create-order:",e),o("Error interno del servidor")}});export{n as default};
//# sourceMappingURL=create-order.mjs.map
