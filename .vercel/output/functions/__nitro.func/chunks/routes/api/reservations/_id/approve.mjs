import{d as r,g as e,s as t,h as o,r as s,a as i,f as a,b as d}from"../../../../_/nitro.mjs";import{createClient as n}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const u=r(async r=>{var u,c,l;const m=e(r),p=await t(r),_=o(r,"id");if("POST"!==m)return s("Método no permitido");if(!_)return s("ID de reserva requerido");try{await i(r);const e=a(),t=n(e.public.supabaseUrl,e.supabaseServiceKey,{auth:{persistSession:!1}}),o=await p.from("reservations").select("*, user:profiles(id, email, first_name, last_name), product:products(id_product, name, price, sku, stock_quantity)").eq("id_reservation",_).single(),m=o.error,f=o.data;if(m||!f)return s("Reserva no encontrada");if("pending"!==f.status)return s("La reserva no está pendiente");const v=Number(f.quantity),b=Number((null==(u=f.product)?void 0:u.price)||0);if(Number((null==(c=f.product)?void 0:c.stock_quantity)||0)<v)return s("Stock insuficiente para aprobar el pedido");const g=await t.from("customers").select("id_customer").eq("user_id",f.user_id).single();let w=null==(l=g.data)?void 0:l.id_customer;if(!g.data||g.error){const r=f.user,e=(null==r?void 0:r.email)||"no-email@local",o=await t.from("customers").select("id_customer").eq("email",e).single(),i=o.error,a=o.data;if(a&&!i){const r=await t.from("customers").update({user_id:f.user_id,is_active:!0,updated_at:(new Date).toISOString()}).eq("id_customer",a.id_customer).select("id_customer").single();if(r.error)return s("Error vinculando cliente",r.error.message);w=r.data.id_customer}else{const o=await t.from("customers").insert({user_id:f.user_id,first_name:(null==r?void 0:r.first_name)||"Cliente",last_name:(null==r?void 0:r.last_name)||"N/A",email:e,is_active:!0}).select("id_customer").single();if(o.error)return s("Error creando cliente",o.error.message);w=o.data.id_customer}}if(!w)return s("No fue posible obtener/crear el cliente");const q=b*v,y={customer_id:w,total_amount:q,subtotal:q,tax_amount:0,shipping_amount:0,status:"confirmed",shipping_address:null,billing_address:null,payment_method:null,payment_status:"paid",tracking_number:null,notes:`Aprobado desde reserva ${_}`,order_source:"admin",assigned_user_id:null},h=await t.from("orders").insert(y).select().single();if(h.error)return s("Error creando pedido",h.error.message);const S=h.data,k={order_id:S.id_order,product_id:f.product_id,quantity:v,unit_price:b,total_price:b*v},E=await t.from("order_items").insert(k);if(E.error)return await p.from("orders").delete().eq("id_order",S.id_order),s("Error creando items del pedido",E.error.message);const N=(await t.rpc("adjust_product_stock",{p_id_product:f.product_id,p_delta:-Number(v)})).error;return N&&console.error("Error descontando stock via RPC:",N),await t.from("reservations").update({status:"converted",updated_at:(new Date).toISOString()}).eq("id_reservation",_),d(S,"Pedido aprobado desde reserva")}catch(r){return console.error("Error en POST /api/reservations/[id]/approve:",r),s("Error interno del servidor")}});export{u as default};
//# sourceMappingURL=approve.mjs.map
