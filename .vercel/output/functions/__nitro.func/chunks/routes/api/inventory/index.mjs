import{d as t,g as o,s as e,r,a,k as n,b as s}from"../../../_/nitro.mjs";import"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const i=t(async t=>{const i=o(t),d=await e(t);if("POST"!==i)return r("Método no permitido");try{await a(t);const o=await n(t);if(!o.product_id||!o.adjustment_type||void 0===o.quantity||null===o.quantity||!o.reason)return r("Todos los campos son obligatorios");const{data:e,error:i}=await d.from("products").select("stock_quantity").eq("id_product",o.product_id).single();if(i||!e)return r("Producto no encontrado");const c=e.stock_quantity;let u=c;switch(o.adjustment_type){case"set":u=o.quantity;break;case"add":u=c+o.quantity;break;case"subtract":u=Math.max(0,c-o.quantity);break;default:return r("Tipo de ajuste no válido")}const p={product_id:o.product_id,movement_type:"adjustment",quantity:Math.abs(u-c),stock_before:c,stock_after:u,reason:o.reason,description:o.description||`Ajuste de stock: ${o.adjustment_type}`,reference:o.reference||null},{data:m,error:l}=await d.from("inventory_movements").insert(p).select().single();if(l)return console.error("Error creando movimiento de ajuste:",l),r("Error creando movimiento de ajuste");const{error:_}=await d.from("products").update({stock_quantity:u,updated_at:(new Date).toISOString()}).eq("id_product",o.product_id);return _?(console.error("Error actualizando stock:",_),await d.from("inventory_movements").delete().eq("id_movement",m.id_movement),r("Error actualizando stock del producto")):s({movement:m,old_stock:c,new_stock:u})}catch(t){return console.error("Error inesperado:",t),r("Error interno del servidor")}});export{i as default};
//# sourceMappingURL=index.mjs.map
