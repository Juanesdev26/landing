import{d as e,g as a,r,c as t,e as i,f as o,b as s}from"../../../_/nitro.mjs";import{createClient as n}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const l=e(async e=>{var l,m;if("POST"!==a(e))return r("MÃ©todo no permitido");try{await t(e);const a=await i(e);if(!a)return r("No autenticado");const d=o(),u=n(d.public.supabaseUrl,d.supabaseServiceKey,{auth:{persistSession:!1}}),{data:p}=await u.from("profiles").select("id, role, email, first_name, last_name").eq("id",a.id).maybeSingle(),f={id:a.id,email:a.email,role:"admin"===(null==p?void 0:p.role)?"admin":"user",updated_at:(new Date).toISOString()};if(null==(l=a.user_metadata)?void 0:l.full_name){const e=String(a.user_metadata.full_name).split(" ");f.first_name=e[0]||(null==p?void 0:p.first_name)||null,f.last_name=e.slice(1).join(" ")||(null==p?void 0:p.last_name)||null}f.name=(null==p?void 0:p.name)||(null==(m=a.user_metadata)?void 0:m.full_name)||a.email;const c=await u.from("profiles").upsert(f,{onConflict:"id"}).select().maybeSingle();return c.error?r("Error guardando perfil",c.error.message):s(c.data||f,"Perfil actualizado")}catch(e){return console.error("POST /api/auth/upsert-profile error:",e),r("Error interno del servidor")}});export{l as default};
//# sourceMappingURL=upsert-profile.mjs.map
