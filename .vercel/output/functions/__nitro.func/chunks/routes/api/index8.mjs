import{d as r,g as e,s as o,f as a,b as i,r as t,a as s,k as n}from"../../_/nitro.mjs";import{createClient as l}from"@supabase/supabase-js";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@supabase/ssr";import"@iconify/utils";import"node:crypto";import"consola";import"ioredis";import"node:fs";import"node:path";const d=r(async r=>{var d,m,u,c,p,f,_;const v=e(r),b=await o(r),h=a(),E=l(h.public.supabaseUrl,h.supabaseServiceKey,{auth:{persistSession:!1}});if("GET"===v)try{const{data:r,error:e}=await E.from("profiles").select("*").order("created_at",{ascending:!1});if(e)return console.error("Error obteniendo perfiles:",e),{data:{success:!1,error:"Error obteniendo perfiles",details:e.message}};const o=r.map(r=>({...r,full_name:`${r.first_name||""} ${r.last_name||""}`.trim()||null}));return i(o)}catch(r){return console.error("Error en GET /api/profiles:",r),t("Error interno del servidor")}if("POST"===v)try{await s(r);const e=await n(r);if(!(e.first_name&&e.last_name&&e.email&&e.password&&e.role))return t("Los campos nombre, apellido, email, contraseña y rol son requeridos");const{data:o,error:v}=await b.from("profiles").select("id").eq("email",e.email).single();if(v&&"PGRST116"!==v.code)return console.error("Error verificando email duplicado:",v),t("Error verificando email duplicado");if(o)return t("Ya existe un usuario con este email");const h=a(),E=l(h.public.supabaseUrl,h.supabaseServiceKey,{auth:{persistSession:!1}}),{data:w,error:y}=await E.auth.admin.createUser({email:e.email.trim().toLowerCase(),password:e.password,email_confirm:!0});if(y)return console.error("Error creando usuario en Auth:",y),t("Error creando usuario en el sistema de autenticación",y.message);const g={id:w.user.id,name:`${e.first_name.trim()} ${e.last_name.trim()}`,first_name:e.first_name.trim(),last_name:e.last_name.trim(),email:e.email.trim().toLowerCase(),phone:(null==(d=e.phone)?void 0:d.trim())||null,address:(null==(m=e.address)?void 0:m.trim())||null,city:(null==(u=e.city)?void 0:u.trim())||null,state:(null==(c=e.state)?void 0:c.trim())||null,postal_code:(null==(p=e.postal_code)?void 0:p.trim())||null,country:(null==(f=e.country)?void 0:f.trim())||null,birth_date:e.birth_date||null,gender:e.gender||null,role:e.role,is_active:void 0===e.is_active||e.is_active,notes:(null==(_=e.notes)?void 0:_.trim())||null},{data:S,error:T}=await E.from("profiles").upsert(g,{onConflict:"id"}).select().single();return T?(console.error("Error creando perfil:",T),await E.auth.admin.deleteUser(w.user.id),t("Error creando perfil del usuario",T.message)):i(S,"Usuario creado exitosamente")}catch(r){return console.error("Error en POST /api/profiles:",r),t("Error interno del servidor")}return t("Método no permitido")});export{d as default};
//# sourceMappingURL=index8.mjs.map
