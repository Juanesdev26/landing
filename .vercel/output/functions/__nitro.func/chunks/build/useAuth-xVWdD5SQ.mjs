import{b as r,z as e}from"./server.mjs";import{computed as a,ref as s,readonly as t}from"vue";const o=()=>r().$supabase.client,i=()=>{const r=o(),n=e("user",()=>null),l=a(()=>!!n.value),c=s(!1);return{user:t(n),isAuthenticated:l,loading:t(c),login:async(e,a)=>{c.value=!0;try{const{data:s,error:t}=await r.auth.signInWithPassword({email:e,password:a});if(t||!s.user)throw new Error("Credenciales incorrectas");try{await $fetch("/api/auth/upsert-profile",{method:"POST"})}catch(r){console.warn("upsert-profile falló tras login")}const{data:l,error:c}=await r.from("profiles").select("*").eq("id",s.user.id).single();if(c||!l)throw new Error("Perfil de usuario no encontrado");if(!["admin","user","customer"].includes(l.role))throw new Error("Rol no permitido");const u={id:l.id,email:l.email,role:l.role,name:l.first_name?`${l.first_name} ${l.last_name||""}`.trim():l.name||null,avatar:l.avatar_url,created_at:l.created_at,updated_at:l.updated_at};return n.value=u,{success:!0,user:u}}catch(r){return console.error("Error en login:",r),{success:!1,error:r instanceof Error?r.message:"Error al iniciar sesión"}}finally{c.value=!1}},logout:async()=>{try{const{error:e}=await r.auth.signOut();return e&&console.error("Error cerrando sesión de Supabase:",e),n.value=null,{success:!0}}catch(r){return console.error("Error en logout:",r),n.value=null,{success:!0}}},checkAuth:async()=>{try{const e=r.auth.getSession(),a=new Promise((r,e)=>setTimeout(()=>e(new Error("Session check timeout")),5e3)),{data:{session:s},error:t}=await Promise.race([e,a]);if(t||!s)return!1;const l=r.from("profiles").select("*").eq("id",s.user.id).single(),c=new Promise((r,e)=>setTimeout(()=>e(new Error("Profile fetch timeout")),5e3)),{data:u,error:m}=await Promise.race([l,c]);return!(m||!u||!["admin","user","customer"].includes(u.role)||(n.value={id:u.id,email:u.email,role:u.role,name:u.first_name?`${u.first_name} ${u.last_name||""}`.trim():u.name||null,avatar:u.avatar_url,created_at:u.created_at,updated_at:u.updated_at},0))}catch(r){return!1}},register:async e=>{c.value=!0;try{const{data:a}=await r.from("users").select("id_user").eq("email",e.email).single();if(a)throw new Error("El email ya está registrado");const s=e.password,{data:t,error:n}=await r.from("users").insert({email:e.email,password_hash:s,first_name:e.first_name,last_name:e.last_name,phone:e.phone,role:"customer",is_active:!0,email_verified:!1}).select().single();if(n)throw new Error("Error al crear usuario");return await r.from("customers").insert({user_id:t.id_user,first_name:t.first_name,last_name:t.last_name,email:t.email,phone:t.phone}),{success:!0,user:t}}catch(r){return console.error("Error en registro:",r),{success:!1,error:r instanceof Error?r.message:"Error al registrar usuario"}}finally{c.value=!1}},changePassword:async(e,a,s)=>{try{const{data:t}=await r.from("users").select("password_hash").eq("id_user",e).single();if(!t||t.password_hash!==a)throw new Error("Contraseña actual incorrecta");const{error:n}=await r.from("users").update({password_hash:s}).eq("id_user",e);if(n)throw new Error("Error al cambiar contraseña");return{success:!0}}catch(r){return console.error("Error cambiando contraseña:",r),{success:!1,error:r instanceof Error?r.message:"Error al cambiar contraseña"}}},updateProfile:async(e,a)=>{try{const{data:s,error:t}=await r.from("users").update(a).eq("id_user",e).select().single();if(t)throw new Error("Error al actualizar perfil");return n.value&&n.value.id===e&&(n.value={...n.value,name:`${s.first_name} ${s.last_name}`,avatar:s.avatar_url,updated_at:s.updated_at},localStorage.setItem("user",JSON.stringify(n.value))),{success:!0,user:s}}catch(r){return console.error("Error actualizando perfil:",r),{success:!1,error:r instanceof Error?r.message:"Error al actualizar perfil"}}}}};export{i,o};
//# sourceMappingURL=useAuth-xVWdD5SQ.mjs.map
